{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "_macros.html" as macros %}

{% block title %}BugList - 首页{% endblock %}
{% block head %} 
{{ super() }} 
<script src="/static/jquery-ui-1.12.1/external/jquery/jquery.js"></script>

<script type="text/javascript">
function fetch(category) {
  $.get('http://jd911.ygct.com:8081/api/list/' + category, function(data) {
    if(data.errormsg != undefined)
    {
      console.log('Errrrr');
    }
    else 
    {
      $.each(data.items, function (index, item){
        $("#"+category).append("<option value='" + item.id + "'>" + item.title + "</option>");
      });
    }
  });
}

$(document).ready(function(){
  fetch("product");
  fetch("source");
  fetch("progress");
  
  $("#table").hide();
  
  $("#apply").click(function(){
	var url='http://jd911.ygct.com:8081/api/list/bugs';
	var param=[];
	
	if($("#product").val() != -1)
		param.append("product_id="+$("#product").val());
		
	if($("#source").val() != -1)
		param.append("product_id="+$("#source").val());
		
	if($("#progress").val() != -1)
		param.append("product_id="+$("#progress").val());
		
	if(param.length != 0)
	    url = url + "?" + param.join("&");
	
	console.log(url);
	
    $.get(url, function(data) {
      if(data.errormsg != undefined)
      {
        console.log('Errrrr');
      }
      else 
      {
	    
	    console.log('Page:' + data.page);
	    console.log('Count:' + data.count);
	    console.log('Page size:' + data.page_size);
		
		if(data.count > 0) 
		{
		  $("#no_record").hide();
		  $("#table").show();
		}
		else
		{
		  $("#no_record").show();
		  $("#table").hide();
		}
		$.each(data.items, function (index, item){
          var html='<tr><td><a href="/details/' + item.id + '", target="_blank">' + item.id + '</a></td><td>' + item.product + '</td><td>' + item.text + '</td><td>' + item.progress + '</td></tr>';
		  $("#tbl_bugs").append(html);
		});
	  }
	});
	
	return false;
  });
});
</script>

{% endblock %}

{% block page_content %}
<div>
<div class="row">
<form class="form-inline">

<div class="form-group">
<label class="control-label" for="product">归属产品</label>
<select class="form-control" id="product" name="product_id">
<option value='-1'>全部</option>
</select>
<label class="control-label" for="source">问题来源</label>
<select class="form-control" id="source" name="source_id">
<option value='-1'>不指定</option>
</select>
<label class="control-label" for="progress">处理进度</label>
<select class="form-control" id="progress" name="progress_id">
<option value='-1'>不指定</option>
</select>
</div>

<div class="form-group">
<button class="btn btn-primary" id="apply">过滤</button>
</div>
</form>
</div>

<div class="row">
<div id="table">
  <table class="table table-hover" id="tbl_bugs">
    <thead>
    <tr><th>No.</th><th nowrap>产品</th><th>描述</th><th nowrap>状态</th></tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  
  <div class="alert alert-info">点击Bug编号，查看详情</div>
</div>
<div class="alert alert-info" id="no_record">无记录</div>
</div>

</div>

{% endblock %}
